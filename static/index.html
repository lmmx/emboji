<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emboji - Semantic Emoji Search</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: #0d1117;
            color: #c9d1d9;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        header {
            padding: 16px 24px;
            border-bottom: 1px solid #30363d;
            display: flex;
            gap: 16px;
            align-items: center;
            flex-wrap: wrap;
        }

        h1 {
            font-size: 20px;
            white-space: nowrap;
        }

        .search-box {
            display: flex;
            gap: 8px;
            flex: 1;
            min-width: 280px;
            max-width: 500px;
        }

        input {
            flex: 1;
            padding: 10px 14px;
            font-size: 16px;
            border: 1px solid #30363d;
            border-radius: 6px;
            background: #161b22;
            color: #c9d1d9;
        }

        input:focus { outline: none; border-color: #58a6ff; }

        button {
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 500;
            background: #238636;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            white-space: nowrap;
        }

        button:hover { background: #2ea043; }

        .status {
            font-size: 13px;
            color: #8b949e;
        }

        main {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .plot-container {
            flex: 1;
            position: relative;
            border-right: 1px solid #30363d;
            min-width: 0;
            overflow: hidden;
        }

        #plot {
            width: 100%;
            height: 100%;
            cursor: grab;
        }

        #plot:active { cursor: grabbing; }

        .sidebar {
            width: 340px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 12px 16px;
            border-bottom: 1px solid #30363d;
            font-size: 13px;
            color: #8b949e;
        }

        .results {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
            gap: 8px;
            align-content: start;
        }

        .emoji-card {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 10px;
            padding: 10px 6px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.15s, border-color 0.15s, background 0.15s;
        }

        .emoji-card:hover {
            transform: translateY(-2px);
            border-color: #58a6ff;
            background: #1c2128;
        }

        .emoji-card.highlighted {
            border-color: #f78166;
            background: #2d1f1f;
        }

        .emoji { font-size: 32px; display: block; }
        .name { font-size: 9px; color: #8b949e; display: block; margin-top: 4px; line-height: 1.2; }
        .score { font-size: 9px; color: #58a6ff; margin-top: 2px; }

        .tooltip {
            position: fixed;
            background: #1c2128;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 12px;
            font-size: 13px;
            pointer-events: none;
            z-index: 1000;
            max-width: 250px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            opacity: 0;
            transition: opacity 0.15s;
            line-height: 1.4;
        }

        .tooltip.visible { opacity: 1; }
        .tooltip .emoji { font-size: 24px; }
        .tooltip .name { font-size: 12px; color: #c9d1d9; margin-top: 4px; }

        footer {
            padding: 12px 24px;
            border-top: 1px solid #30363d;
            font-size: 12px;
            color: #6e7681;
            text-align: center;
        }

        footer a { color: #58a6ff; text-decoration: none; }
        footer a:hover { text-decoration: underline; }

        @media (max-width: 800px) {
            main { flex-direction: column; }
            .plot-container { height: 50vh; border-right: none; border-bottom: 1px solid #30363d; }
            .sidebar { width: 100%; }
        }
    </style>
</head>
<body>
    <header>
        <h1>üîç Emboji</h1>
        <div class="search-box">
            <input type="text" id="q" placeholder="Search emojis... (happy, fire, love, crying)" autofocus />
            <button id="btn">Search</button>
        </div>
        <span class="status" id="status">Loading...</span>
    </header>

    <main>
        <div class="plot-container">
            <canvas id="plot"></canvas>
        </div>
        <aside class="sidebar">
            <div class="sidebar-header" id="results-header">Search results</div>
            <div class="results" id="results"></div>
        </aside>
    </main>

    <div class="tooltip" id="tooltip">
        <span class="emoji"></span>
        <span class="name"></span>
    </div>

    <footer>
        Built with <a href="https://github.com/lmmx/polars-fastembed">polars-fastembed</a>
    </footer>

    <script>
        const $ = id => document.getElementById(id);
        const canvas = $('plot');
        const ctx = canvas.getContext('2d');
        const tooltip = $('tooltip');

        let allEmojis = [];
        let searchResults = new Set();
        let searchResultsData = [];
        let displayEmojis = []; // Emojis to actually render

        let xScale, yScale;
        let currentTransform = d3.zoomIdentity;

        // D3 zoom behavior (controls transform only, not rendering)
        const zoom = d3.zoom()
            .scaleExtent([0.5, 20])
            .on('zoom', (event) => {
                currentTransform = event.transform;
                render();
            });

        d3.select(canvas).call(zoom);

        // Double-click to reset
        d3.select(canvas).on('dblclick.zoom', null);
        d3.select(canvas).on('dblclick', () => {
            d3.select(canvas).transition().duration(500).call(zoom.transform, d3.zoomIdentity);
        });

        function debounce(fn, ms) {
            let timeout;
            return (...args) => {
                clearTimeout(timeout);
                timeout = setTimeout(() => fn(...args), ms);
            };
        }

        async function loadEmojis() {
            $('status').textContent = 'Loading emojis...';
            const res = await fetch('/api/emojis');
            allEmojis = await res.json();
            displayEmojis = allEmojis; // Show all initially

            $('status').textContent = `${allEmojis.length} emojis loaded`;
            initializeScales();
            render();
        }

        function initializeScales() {
            const container = document.querySelector('.plot-container');
            const width = container.clientWidth;
            const height = container.clientHeight;
            
            const dpr = window.devicePixelRatio || 1;
            canvas.width = width * dpr;
            canvas.height = height * dpr;
            canvas.style.width = width + 'px';
            canvas.style.height = height + 'px';
            ctx.scale(dpr, dpr);

            const padding = 40;
            const xExtent = d3.extent(allEmojis, d => d.x);
            const yExtent = d3.extent(allEmojis, d => d.y);

            xScale = d3.scaleLinear()
                .domain(xExtent)
                .range([padding, width - padding]);

            yScale = d3.scaleLinear()
                .domain(yExtent)
                .range([padding, height - padding]);
        }

        function render() {
            const width = canvas.clientWidth;
            const height = canvas.clientHeight;

            // Clear canvas
            ctx.fillStyle = '#0d1117';
            ctx.fillRect(0, 0, width, height);

            const hasSearch = searchResults.size > 0;
            const baseSize = 18;
            const scale = currentTransform.k;
            const fontSize = Math.max(12, baseSize * scale);

            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.globalAlpha = 1;
            ctx.font = `${fontSize}px sans-serif`;

            // Only render emojis in displayEmojis array
            for (const e of displayEmojis) {
                const x = xScale(e.x) * scale + currentTransform.x;
                const y = yScale(e.y) * scale + currentTransform.y;
                
                // Cull off-screen emojis
                if (x < -50 || x > width + 50 || y < -50 || y > height + 50) continue;
                
                ctx.fillText(e.c, x, y);
            }

            ctx.globalAlpha = 1;
        }

        // Find emoji under cursor
        function findEmojiAtPoint(x, y) {
            const scale = currentTransform.k;
            const hitRadius = 20 * scale;
            let closest = null;
            let closestDist = hitRadius;

            for (const e of displayEmojis) {
                const ex = xScale(e.x) * scale + currentTransform.x;
                const ey = yScale(e.y) * scale + currentTransform.y;
                const dist = Math.hypot(ex - x, ey - y);
                
                if (dist < closestDist) {
                    closestDist = dist;
                    closest = e;
                }
            }

            return closest;
        }

        // Mouse move handler for tooltip
        canvas.addEventListener('mousemove', (e) => {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            const emoji = findEmojiAtPoint(x, y);

            if (emoji) {
                tooltip.querySelector('.emoji').textContent = emoji.c;
                tooltip.querySelector('.name').textContent = emoji.n;
                tooltip.classList.add('visible');
                tooltip.style.left = (e.clientX + 12) + 'px';
                tooltip.style.top = (e.clientY + 12) + 'px';
            } else {
                tooltip.classList.remove('visible');
            }
        });

        canvas.addEventListener('mouseleave', () => {
            tooltip.classList.remove('visible');
        });

        async function search() {
            const q = $('q').value.trim();
            if (!q) {
                searchResults.clear();
                searchResultsData = [];
                displayEmojis = allEmojis; // Show all emojis when no search
                $('results').innerHTML = '';
                $('results-header').textContent = 'Search results';
                render();
                return;
            }

            $('status').textContent = 'Searching...';
            $('btn').disabled = true;

            try {
                const res = await fetch(`/api/search?q=${encodeURIComponent(q)}&k=60`);
                const results = await res.json();

                searchResultsData = results;
                searchResults = new Set(results.map(r => r.c));
                
                // Only display search results
                displayEmojis = allEmojis.filter(e => searchResults.has(e.c));

                $('results').innerHTML = results.map(e => `
                    <div class="emoji-card" data-emoji="${e.c}" title="${e.d}">
                        <span class="emoji">${e.c}</span>
                        <span class="name">${e.n}</span>
                        <span class="score">${(e.s * 100).toFixed(0)}%</span>
                    </div>
                `).join('');

                $('results-header').textContent = `"${q}" ‚Üí ${results.length} results`;
                $('status').textContent = `${allEmojis.length} emojis loaded`;

                render();
            } catch (err) {
                $('status').textContent = `Error: ${err.message}`;
            }

            $('btn').disabled = false;
        }

        // Event handlers
        $('btn').onclick = search;
        $('q').onkeypress = e => { if (e.key === 'Enter') search(); };

        // Clear search on empty input
        $('q').oninput = debounce(() => {
            if ($('q').value.trim() === '') {
                searchResults.clear();
                searchResultsData = [];
                displayEmojis = allEmojis; // Show all emojis
                $('results').innerHTML = '';
                $('results-header').textContent = 'Search results';
                render();
            }
        }, 200);

        // Click on result card to copy emoji
        $('results').onclick = e => {
            const card = e.target.closest('.emoji-card');
            if (card) {
                const emoji = card.dataset.emoji;
                navigator.clipboard.writeText(emoji);
                $('status').textContent = `Copied ${emoji}!`;
                setTimeout(() => $('status').textContent = `${allEmojis.length} emojis loaded`, 1500);
            }
        };

        // Handle window resize
        window.addEventListener('resize', debounce(() => {
            initializeScales();
            render();
        }, 200));

        // Init
        loadEmojis().catch(err => {
            $('status').textContent = `Error: ${err.message}`;
        });
    </script>
</body>
</html>